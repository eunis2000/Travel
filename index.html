  <!DOCTYPE html>
  <html lang="zh-HK">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <title>Minty Travel v7.3 (Full) âœˆï¸</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
      <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
      <style>
          body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #f0fdf4; }
          .hide-scrollbar::-webkit-scrollbar { display: none; }
          .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
          .mint-gradient { background: linear-gradient(135deg, #34d399 0%, #10b981 100%); }
          .card-shadow { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.1); }
          .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
          .fade-enter-from, .fade-leave-to { opacity: 0; }
          .list-move, .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
          .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
          .list-leave-active { position: absolute; }
          [v-cloak] { display: none; }
      </style>
  </head>
  <body class="text-slate-600 pb-24">

      <div id="app" class="max-w-md mx-auto min-h-screen bg-[#f0fdf4] relative shadow-2xl overflow-hidden" v-cloak>
          
          <!-- é ‚éƒ¨æ¨™é¡Œ -->
          <header class="bg-white/80 backdrop-blur-md sticky top-0 z-20 px-6 py-4 border-b border-teal-100 flex justify-between items-center">
              <h1 class="text-xl font-bold text-teal-600 flex items-center gap-2 truncate max-w-[60%]">
                  <span>âœˆï¸</span> {{ tripTitle }}
              </h1>
              <div class="text-xs font-bold text-teal-400 bg-teal-50 px-2 py-1 rounded-lg whitespace-nowrap">
                  {{ tripDateRange }}
              </div>
          </header>

          <!-- 1. è¡Œç¨‹é é¢ -->
          <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4 pb-24">
              <div class="flex overflow-x-auto gap-2 pb-2 hide-scrollbar">
                  <button v-for="(day, index) in itinerary" :key="index"
                      @click="currentDayIndex = index"
                      :class="currentDayIndex === index ? 'bg-teal-500 text-white shadow-lg shadow-teal-200' : 'bg-white text-teal-500 border border-teal-100'"
                      class="flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm transition-all whitespace-nowrap">
                      {{ day.date }}
                  </button>
              </div>

              <div class="space-y-3 relative">
                  <transition-group name="list">
                      <div v-for="(event, idx) in itinerary[currentDayIndex].events" :key="event.id || idx" class="bg-white p-4 rounded-2xl card-shadow border-l-4 border-teal-400 relative group mb-3">
                          <button @click="toggleEdit(currentDayIndex, idx)" class="absolute top-2 right-2 text-gray-300 hover:text-teal-500">âœ</button>
                          <div v-if="!event.isEditing">
                              <div class="flex items-center gap-3 mb-2">
                                  <span class="bg-teal-50 text-teal-600 text-xs font-bold px-2 py-1 rounded">{{ event.time }}</span>
                                  <h3 class="font-bold text-gray-700">{{ event.activity }}</h3>
                              </div>
                              <div class="flex items-center justify-between text-sm text-gray-500 pl-1">
                                  <div class="flex items-center gap-1 truncate max-w-[70%]"><span>ğŸ“</span> {{ event.location }}</div>
                                  <a :href="getMapLink(event.location)" target="_blank" class="text-teal-500 font-bold text-xs flex items-center gap-1 bg-teal-50 px-2 py-1 rounded-full hover:bg-teal-100">å°èˆª â†—</a>
                              </div>
                              <div v-if="event.transport" class="mt-2 text-xs text-slate-400 flex items-center gap-1 border-t border-gray-50 pt-2"><span>ğŸš‡</span> {{ event.transport }}</div>
                          </div>
                          <div v-else class="space-y-2">
                              <div class="flex gap-2">
                                  <input v-model="event.time" type="time" class="w-1/3 bg-gray-50 p-2 rounded text-sm">
                                  <input v-model="event.activity" type="text" placeholder="æ´»å‹•åç¨±" class="w-2/3 bg-gray-50 p-2 rounded text-sm font-bold">
                              </div>
                              <input v-model="event.location" type="text" placeholder="è¼¸å…¥åœ°å€" class="w-full bg-gray-50 p-2 rounded text-sm">
                              <input v-model="event.transport" type="text" placeholder="äº¤é€šæ–¹å¼" class="w-full bg-gray-50 p-2 rounded text-sm">
                              <div class="flex gap-2">
                                  <button @click="deleteEvent(currentDayIndex, idx)" class="w-1/4 bg-red-100 text-red-400 text-xs font-bold py-2 rounded-lg">åˆªé™¤</button>
                                  <button @click="toggleEdit(currentDayIndex, idx)" class="w-3/4 bg-teal-500 text-white text-xs font-bold py-2 rounded-lg">å®Œæˆ</button>
                              </div>
                          </div>
                      </div>
                  </transition-group>
                  
                  <div v-if="itinerary[currentDayIndex].events.length === 0" class="text-center py-10 text-gray-300 border-2 border-dashed border-gray-100 rounded-2xl">
                      é€™å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ ğŸ˜´
                  </div>

                  <button @click="addEvent(currentDayIndex)" class="w-full py-3 border-2 border-dashed border-teal-200 text-teal-400 rounded-xl font-bold text-sm hover:bg-teal-50 transition">+ æ–°å¢è¡Œç¨‹</button>
              </div>
              
              <div class="mt-6 bg-white p-4 rounded-2xl border border-teal-100 shadow-sm space-y-3">
                  <h3 class="text-xs font-bold text-gray-400 mb-2">ğŸ“¤ åˆ†äº«èˆ‡å°å‡º</h3>
                  <div class="grid grid-cols-2 gap-3">
                      <button @click="copyDayItineraryText" class="bg-teal-50 text-teal-600 py-2.5 rounded-xl text-xs font-bold active:scale-95 transition flex items-center justify-center gap-1 border border-teal-200">
                          ğŸ“‹ è¤‡è£½æœ¬æ—¥ ({{ safeDate(itinerary[currentDayIndex]) }})
                      </button>
                      <button @click="copyItineraryText" class="bg-teal-500 text-white py-2.5 rounded-xl text-xs font-bold shadow-md shadow-teal-100 active:scale-95 transition flex items-center justify-center gap-1">
                          ğŸ“‘ è¤‡è£½æ•´è¶Ÿæ—…ç¨‹
                      </button>
                  </div>
                  <button @click="exportSpecific('itinerary')" class="w-full text-gray-400 text-[10px] font-bold underline hover:text-teal-500 py-1">
                      ğŸ“¥ ä¸‹è¼‰è¡Œç¨‹å‚™ä»½æª” (.json)
                  </button>
              </div>
          </div>

          <!-- 2. è³¼ç‰©è¨˜å¸³é é¢ -->
          <div v-if="currentTab === 'shopping'" class="p-4 space-y-4">
              <div class="mint-gradient rounded-2xl p-5 text-white shadow-lg shadow-teal-200">
                  <div class="flex justify-between items-end">
                      <div>
                          <div class="text-teal-100 text-xs">ç¸½æ¶ˆè²» (JPY)</div>
                          <div class="text-2xl font-bold">Â¥{{ formatNumber(totalYen) }}</div>
                      </div>
                      <div class="text-right">
                          <div class="text-teal-100 text-xs">å¯¦éš›æ”¯å‡º (HKD)</div>
                          <div class="text-xl font-bold">HK${{ formatNumber(totalHKD) }}</div>
                      </div>
                  </div>
              </div>

              <div class="flex justify-end">
                  <button @click="showMemberSettings = true" class="text-xs font-bold text-teal-600 bg-teal-50 px-3 py-1.5 rounded-lg flex items-center gap-1 hover:bg-teal-100 transition">
                      âš™ï¸ è¨­å®š/æ–°å¢æ—…ä¼´
                  </button>
              </div>

              <div v-if="categoryStats.length > 0" class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                  <div v-for="stat in categoryStats" :key="stat.id" class="bg-white p-3 rounded-xl border border-gray-100 min-w-[110px] flex-shrink-0 shadow-sm">
                      <div class="text-[10px] font-bold mb-1 flex items-center gap-1" :class="stat.text || 'text-gray-500'">
                          <span class="w-2 h-2 rounded-full" :class="stat.bg || 'bg-gray-300'"></span>
                          {{ stat.name }}
                      </div>
                      <div class="font-bold text-gray-700 text-sm">HK${{ formatNumber(stat.sumHKD) }}</div>
                  </div>
              </div>

              <div class="bg-white p-4 rounded-2xl card-shadow space-y-3">
                  <div class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
                      <button v-for="cat in categories" :key="cat.id" 
                          @click="newItem.category = cat.id"
                          :class="newItem.category === cat.id ? cat.activeClass : 'bg-gray-50 text-gray-400 hover:bg-gray-100'"
                          class="px-4 py-2 rounded-lg text-xs font-bold transition whitespace-nowrap">
                          {{ cat.name }}
                      </button>
                  </div>

                  <div class="flex gap-2">
                      <input v-model="newItem.name" type="text" placeholder="ç‰©å“åç¨±" class="flex-1 bg-gray-50 p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-teal-200">
                      <input v-model="newItem.forWhom" type="text" placeholder="å‚™è¨»/çµ¦èª°?" class="w-24 bg-gray-50 p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-teal-200">
                  </div>
                  
                  <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl">
                      <span class="text-[10px] font-bold text-gray-400 whitespace-nowrap">AAåˆ†å¸³:</span>
                      <div class="flex gap-1 flex-1 overflow-x-auto hide-scrollbar">
                          <button v-for="(member, idx) in members" :key="idx"
                              @click="toggleMember(idx)"
                              :class="newItem.sharedWith.includes(idx) ? 'bg-teal-500 text-white shadow-sm' : 'bg-white text-gray-400 border border-gray-200'"
                              class="px-3 py-1.5 rounded-lg text-[10px] font-bold transition whitespace-nowrap">
                              {{ member }}
                          </button>
                      </div>
                  </div>

                  <div class="flex gap-2 items-center">
                      <div class="flex-1 flex gap-1">
                          <input v-model.number="newItem.price" type="number" placeholder="JPY" class="w-1/2 bg-gray-50 p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-teal-200">
                          <input v-model.number="newItem.priceHKD" type="number" placeholder="HKD(é¸å¡«)" class="w-1/2 bg-gray-50 p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-teal-200 border border-dashed border-gray-300">
                      </div>
                      <div class="relative">
                          <button @click="$refs.shopCam.click()" class="p-2 rounded-xl transition" :class="tempShopImg ? 'bg-teal-100 text-teal-600' : 'bg-gray-100 text-gray-400'">ğŸ“·</button>
                          <input type="file" ref="shopCam" accept="image/*" capture="environment" class="hidden" @change="handleShopImgUpload">
                          <div v-if="tempShopImg" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                      </div>
                      <button @click="addItem" class="bg-teal-500 text-white px-3 py-2 rounded-xl font-bold shadow-md shadow-teal-100 active:scale-95 transition text-sm whitespace-nowrap">è¨˜å¸³</button>
                  </div>
                  
                  <div v-if="tempShopImg" class="relative inline-block mt-2">
                      <img :src="tempShopImg" class="h-16 w-16 object-cover rounded-lg border border-teal-200">
                      <button @click="tempShopImg = null" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">Ã—</button>
                  </div>
              </div>

              <div class="space-y-2 pb-20">
                  <div v-for="(item, index) in shoppingList" :key="index" class="bg-white p-3 rounded-xl border border-gray-100 flex gap-3 items-center relative overflow-hidden">
                      <div @click="item.image ? openImageModal(item.image) : null" class="w-12 h-12 rounded-lg flex-shrink-0 overflow-hidden flex items-center justify-center cursor-pointer ml-1" :class="!item.image ? getCategoryBg(item.category) : 'bg-gray-50 border border-gray-100'">
                          <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                          <span v-else class="text-lg font-bold opacity-80" :class="getCategoryText(item.category)">{{ getCategoryName(item.category).charAt(0) }}</span>
                      </div>
                      <div class="flex-1 min-w-0">
                          <div class="font-bold text-gray-700 truncate">{{ item.name }}</div>
                          <div class="flex flex-wrap gap-1 mt-1">
                              <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-50 text-gray-400">{{ getCategoryName(item.category) }}</span>
                              <span v-if="item.sharedWith && item.sharedWith.length > 0 && !(item.sharedWith.length === 1 && item.sharedWith[0] === 0)" class="text-[10px] px-1.5 py-0.5 rounded bg-indigo-50 text-indigo-500 flex items-center gap-0.5">
                                  ğŸ‘¥ {{ getSharedNames(item.sharedWith) }}
                              </span>
                              <span v-else-if="item.forWhom" class="text-[10px] px-1.5 py-0.5 rounded bg-orange-50 text-orange-400">çµ¦: {{ item.forWhom }}</span>
                          </div>
                      </div>
                      <div class="text-right flex flex-col items-end">
                          <div v-if="item.priceHKD" class="font-bold text-indigo-600">HK${{ item.priceHKD }}</div>
                          <div v-else class="font-bold text-teal-600">Â¥{{ item.price }}</div>
                          <div v-if="item.priceHKD" class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded mt-0.5">é›»å­æ”¯ä»˜</div>
                          <div v-else class="text-[10px] text-gray-300">ç´„ HK${{ (item.price * rate).toFixed(0) }}</div>
                      </div>
                      <button @click="deleteItem(index)" class="absolute top-3 right-2 text-xs text-white bg-red-400 rounded-full w-5 h-5 flex items-center justify-center shadow-sm hover:bg-red-500 transition">âœ•</button>
                  </div>
                  <div v-if="shoppingList.length === 0" class="text-center text-gray-300 py-10 text-sm">é‚„æ²’è²·æ±è¥¿å‘¢ ğŸ›ï¸</div>
              </div>
              
              <div class="fixed bottom-24 right-4 flex flex-col gap-2 items-end">
                  <button @click="showSettlement = true" class="bg-indigo-500 text-white p-3 rounded-full shadow-lg shadow-indigo-200 font-bold text-xs flex items-center gap-1">ğŸ’° æŸ¥çœ‹çµç®—</button>
                  <button @click="exportToCSV" class="bg-green-600 text-white p-3 rounded-full shadow-lg border border-green-400 font-bold text-xs flex items-center gap-1 active:scale-95 transition">ğŸ“¥ å°å‡º Excel</button>
              </div>
          </div>

          <!-- 3. ç…§ç‰‡è¨˜éŒ„é é¢ -->
          <div v-if="currentTab === 'photos'" class="p-4 pb-24">
              <div @click="$refs.photoInput.click()" class="w-full h-24 border-2 border-dashed border-teal-300 rounded-xl flex flex-col items-center justify-center bg-teal-50 cursor-pointer hover:bg-teal-100 transition mb-6">
                  <span class="text-2xl">ğŸ“·</span>
                  <span class="text-xs text-teal-500 font-bold mt-1">æ–°å¢ä»Šæ—¥ç…§ç‰‡</span>
                  <input type="file" ref="photoInput" accept="image/*" class="hidden" @change="handlePhotoUpload">
              </div>
              <div v-for="(group, date) in groupedPhotos" :key="date" class="mb-6">
                  <h3 class="font-bold text-teal-600 mb-2 pl-1 flex items-center gap-2">
                      ğŸ“… {{ date }} <span class="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{{ group.length }} å¼µ</span>
                  </h3>
                  <div class="grid grid-cols-3 gap-2">
                      <div v-for="(photo, idx) in group" :key="idx" class="aspect-square rounded-lg overflow-hidden relative group bg-gray-100">
                          <img :src="photo.src" @click="openImageModal(photo.src)" class="w-full h-full object-cover cursor-pointer">
                          <button @click="deletePhoto(photo.originalIndex)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full w-5 h-5 text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition">âœ•</button>
                      </div>
                  </div>
              </div>
              <div v-if="photos.length === 0" class="text-center text-gray-300 py-10">æš«ç„¡ç…§ç‰‡</div>
              
              <div class="mt-8 text-center">
                  <button @click="exportSpecific('photos')" class="bg-teal-50 text-teal-600 px-6 py-2 rounded-full text-xs font-bold">ğŸ“¥ å°å‡ºæ‰€æœ‰ç…§ç‰‡</button>
              </div>
          </div>

          <!-- 4. å·¥å…·é é¢ -->
          <div v-if="currentTab === 'tools'" class="p-4 space-y-4">
              <!-- è¡Œç¨‹è¨­å®š -->
              <div class="bg-white p-5 rounded-2xl border border-teal-200 shadow-sm">
                  <h3 class="font-bold text-teal-600 mb-3 flex items-center gap-2">âš™ï¸ è¡Œç¨‹è¨­å®š</h3>
                  <div class="space-y-3">
                      <div>
                          <label class="text-xs text-gray-400 block mb-1">æ—…ç¨‹æ¨™é¡Œ</label>
                          <input v-model="tripTitle" type="text" class="w-full bg-gray-50 p-2 rounded-lg text-sm font-bold text-gray-700 border border-gray-100 focus:border-teal-300 outline-none">
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                          <div>
                              <label class="text-xs text-gray-400 block mb-1">å‡ºç™¼ (Start)</label>
                              <input v-model="startDate" type="date" class="w-full bg-gray-50 p-2 rounded-lg text-sm font-bold text-gray-700 border border-gray-100 focus:border-teal-300 outline-none">
                          </div>
                          <div>
                              <label class="text-xs text-gray-400 block mb-1">å›ç¨‹ (End)</label>
                              <input v-model="endDate" type="date" class="w-full bg-gray-50 p-2 rounded-lg text-sm font-bold text-gray-700 border border-gray-100 focus:border-teal-300 outline-none">
                          </div>
                      </div>
                      <p class="text-[10px] text-orange-400 mt-1 bg-orange-50 p-2 rounded-lg">
                          ğŸ’¡ æç¤ºï¼šä¿®æ”¹ã€Œå›ç¨‹æ—¥æœŸã€æœƒè‡ªå‹•å¢åŠ æˆ–æ¸›å°‘è¡Œç¨‹å¤©æ•¸ã€‚
                      </p>
                  </div>
              </div>

              <div class="bg-white p-5 rounded-2xl border border-teal-200 shadow-sm">
                  <h3 class="font-bold text-teal-600 mb-3 flex items-center gap-2">ğŸ’¾ æ•¸æ“šå‚™ä»½ä¸­å¿ƒ</h3>
                  <div class="mb-4 pb-4 border-b border-gray-100">
                      <button @click="exportAllData" class="w-full bg-teal-500 text-white py-3 rounded-xl font-bold text-sm shadow-md shadow-teal-100 active:scale-95 transition flex items-center justify-center gap-2">
                          <span class="text-xl">ğŸ“¦</span> ä¸‹è¼‰å®Œæ•´å‚™ä»½ (All-in-One)
                      </button>
                  </div>
                  <div class="mb-4">
                      <p class="text-xs font-bold text-gray-500 mb-2">ğŸ“… æŒ‰æ—¥æœŸå°å‡º (è¡Œç¨‹+è¨˜å¸³+ç…§ç‰‡)</p>
                      <div class="flex flex-wrap gap-2 mb-3">
                          <label v-for="(day, idx) in itinerary" :key="idx" class="flex items-center gap-1 bg-gray-50 px-3 py-1.5 rounded-lg cursor-pointer select-none border" :class="selectedExportDates.includes(day.date) ? 'border-teal-500 bg-teal-50 text-teal-600' : 'border-transparent'">
                              <input type="checkbox" :value="day.date" v-model="selectedExportDates" class="hidden">
                              <span class="text-xs font-bold">{{ safeDate(day).split(' ')[0] }}</span>
                          </label>
                      </div>
                      <button @click="exportByDate" class="w-full bg-white border border-teal-200 text-teal-600 py-2 rounded-xl font-bold text-xs active:scale-95 transition hover:bg-teal-50">
                          ğŸ“¥ å°å‡ºé¸ä¸­æ—¥æœŸè³‡æ–™
                      </button>
                  </div>
                  <label class="block w-full bg-gray-50 border-2 border-dashed border-gray-200 text-gray-400 py-2 rounded-xl font-bold text-xs text-center cursor-pointer hover:bg-gray-100 transition">
                      ğŸ”„ å°å…¥å‚™ä»½æª”æ¡ˆ
                      <input type="file" @change="importAllData" accept=".json" class="hidden">
                  </label>
              </div>
              <div class="bg-white p-5 rounded-2xl card-shadow">
                  <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">ğŸ’± åŒ¯ç‡è¨ˆç®—</h3>
                  <div class="flex items-center gap-2 mb-4">
                      <span class="text-xs text-gray-400">è¨­å®š: 1 JPY = </span>
                      <input v-model.number="rate" type="number" step="0.001" class="w-20 bg-gray-50 p-1 text-center rounded text-sm">
                      <span class="text-xs text-gray-400">HKD</span>
                  </div>
                  <div class="grid grid-cols-[1fr,auto,1fr] gap-2 items-center">
                      <div>
                          <label class="text-xs text-gray-400 block mb-1">æ—¥åœ“ (JPY)</label>
                          <input v-model="calcYen" @input="updateHkd" type="number" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-teal-600 outline-none focus:ring-2 focus:ring-teal-200">
                      </div>
                      <div class="text-gray-300">â†”</div>
                      <div>
                          <label class="text-xs text-gray-400 block mb-1">æ¸¯å¹£ (HKD)</label>
                          <input v-model="calcHkd" @input="updateYen" type="number" class="w-full bg-gray-50 p-3 rounded-xl font-bold text-teal-600 outline-none focus:ring-2 focus:ring-teal-200">
                      </div>
                  </div>
              </div>
              <div class="pt-4 pb-8 text-center">
                  <button @click="resetAllData" class="text-[10px] text-red-300 hover:text-red-500 underline">âš ï¸ App ç„¡æ³•ä½¿ç”¨ï¼Ÿé»æ­¤é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
              </div>
          </div>

          <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-3 flex justify-between items-center z-30 max-w-md mx-auto text-[10px]">
              <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-teal-500' : 'text-gray-400'" class="flex flex-col items-center gap-1 transition"><span class="text-xl">ğŸ“…</span> è¡Œç¨‹</button>
              <button @click="currentTab = 'shopping'" :class="currentTab === 'shopping' ? 'text-teal-500' : 'text-gray-400'" class="flex flex-col items-center gap-1 transition"><span class="text-xl">ğŸ›ï¸</span> è¨˜å¸³</button>
              <button @click="currentTab = 'photos'" :class="currentTab === 'photos' ? 'text-teal-500' : 'text-gray-400'" class="flex flex-col items-center gap-1 transition"><span class="text-xl">ğŸ“·</span> ç›¸å†Š</button>
              <button @click="currentTab = 'tools'" :class="currentTab === 'tools' ? 'text-teal-500' : 'text-gray-400'" class="flex flex-col items-center gap-1 transition"><span class="text-xl">ğŸ§°</span> å·¥å…·</button>
          </nav>
          
          <!-- Modal: åœ–ç‰‡æŸ¥çœ‹ -->
          <transition name="fade">
              <div v-if="showModal" @click="showModal = false" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                  <img :src="modalImage" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
                  <button class="absolute top-4 right-4 text-white text-3xl">Ã—</button>
              </div>
          </transition>

          <!-- Modal: æˆå“¡è¨­å®š -->
          <transition name="fade">
              <div v-if="showMemberSettings" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                  <div class="bg-white rounded-2xl p-5 w-full max-w-xs shadow-2xl flex flex-col max-h-[80vh]">
                      <h3 class="font-bold text-teal-600 mb-2 text-center">ğŸ‘¥ è¨­å®šåŒè¡Œæ—…ä¼´</h3>
                      <p class="text-[10px] text-gray-400 text-center mb-4">å¯è‡ªç”±æ–°å¢ï¼Œä¿®æ”¹åå­—æœƒå³æ™‚æ›´æ–°</p>
                      
                      <div class="space-y-3 overflow-y-auto flex-1 hide-scrollbar mb-4">
                          <div v-for="(m, idx) in members" :key="idx" class="flex items-center gap-2">
                              <span class="text-xs text-gray-400 w-6">#{{idx+1}}</span>
                              <input v-model="members[idx]" type="text" class="flex-1 bg-gray-50 p-2 rounded-lg text-sm border border-gray-100 focus:border-teal-300 outline-none" :placeholder="'æ—…ä¼´ ' + (idx+1)" :disabled="idx===0">
                              <button v-if="idx !== 0" @click="deleteMember(idx)" class="text-red-400 hover:text-red-600 p-2">ğŸ—‘ï¸</button>
                          </div>
                      </div>
                      
                      <div class="flex gap-2 mb-2">
                          <input v-model="newMemberName" type="text" placeholder="è¼¸å…¥æ–°æ—…ä¼´åå­—" class="flex-1 bg-gray-50 p-2 rounded-lg text-sm border border-gray-100 outline-none">
                          <button @click="addNewMember" class="bg-teal-100 text-teal-600 px-3 rounded-lg font-bold text-sm">+</button>
                      </div>

                      <button @click="showMemberSettings = false" class="w-full bg-teal-500 text-white py-2 rounded-xl font-bold text-sm">å®Œæˆ</button>
                  </div>
              </div>
          </transition>

          <!-- Modal: çµç®—å ±è¡¨ -->
          <transition name="fade">
              <div v-if="showSettlement" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                  <div class="bg-white rounded-2xl p-5 w-full max-w-xs shadow-2xl">
                      <h3 class="font-bold text-indigo-600 mb-1 text-center">ğŸ’° AA çµç®—å ±è¡¨</h3>
                      <p class="text-[10px] text-gray-400 text-center mb-4">å‡è¨­æ‰€æœ‰æ¬¾é …ç”±ã€Œ{{members[0]}}ã€å…ˆå¢Šä»˜</p>
                      
                      <div class="space-y-3 mb-4 max-h-[50vh] overflow-y-auto hide-scrollbar">
                          <div v-for="(amount, idx) in settlement" :key="idx" class="flex justify-between items-center border-b border-gray-50 pb-2">
                              <div class="flex items-center gap-2">
                                  <span class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center text-xs font-bold">{{ (members[idx] || '?').charAt(0) }}</span>
                                  <span class="text-sm font-bold text-gray-600">{{ members[idx] }}</span>
                              </div>
                              <div class="text-right">
                                  <div class="text-xs text-gray-400">æ‡‰ä»˜</div>
                                  <div class="font-bold text-indigo-600">HK${{ formatNumber(amount.toFixed(1)) }}</div>
                              </div>
                          </div>
                          <div v-if="Object.keys(settlement).length === 0" class="text-center text-gray-300 text-xs py-4">æš«ç„¡ AA å¸³ç›®</div>
                      </div>
                      <button @click="showSettlement = false" class="w-full bg-gray-100 text-gray-600 py-2 rounded-xl font-bold text-sm">é—œé–‰</button>
                  </div>
              </div>
          </transition>

      </div>

      <script>
          const { createApp, ref, computed, watch, onMounted } = Vue;

          createApp({
              setup() {
                  const currentTab = ref('itinerary');
                  const currentDayIndex = ref(0);
                  
                  // æ ¸å¿ƒè¨­å®š
                  const tripTitle = ref('å¤§é˜ªä¹‹æ—…');
                  const startDate = ref('2025-12-05');
                  const endDate = ref('2025-12-09');
                  const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

                  const safeDate = (dayObj) => {
                      if (dayObj && dayObj.date) return dayObj.date;
                      return 'Unknown Date';
                  };

                  const defaultItinerary = [
                      { events: [{ id: 1, time: '08:00', activity: 'é¦™æ¸¯æ©Ÿå ´é›†åˆ', location: 'é¦™æ¸¯åœ‹éš›æ©Ÿå ´ T1', transport: 'æ©Ÿå ´å¿«ç·š', isEditing: false }, { id: 2, time: '11:30', activity: 'HX618 èµ·é£›', location: 'HKG -> KIX', transport: 'é£›æ©Ÿ', isEditing: false }, { id: 3, time: '16:00', activity: 'æŠµé”å¤§é˜ª', location: 'é—œè¥¿åœ‹éš›æ©Ÿå ´', transport: 'å…¥å¢ƒ', isEditing: false }, { id: 4, time: '18:00', activity: 'å‰å¾€å¸‚å€', location: 'å¤§é˜ªå¸‚å€', transport: 'å—æµ·é›»éµ', isEditing: false }] },
                      { events: [{ id: 5, time: '09:00', activity: 'é–‹å§‹è¡Œç¨‹', location: 'å¤§é˜ª', transport: '', isEditing: false }] },
                      { events: [{ id: 6, time: '09:00', activity: 'é–‹å§‹è¡Œç¨‹', location: 'å¤§é˜ª', transport: '', isEditing: false }] },
                      { events: [{ id: 7, time: '09:00', activity: 'é–‹å§‹è¡Œç¨‹', location: 'å¤§é˜ª', transport: '', isEditing: false }] },
                      { events: [{ id: 8, time: '10:00', activity: 'æœ€å¾Œè³¼ç‰©', location: 'é›£æ³¢', transport: '', isEditing: false }, { id: 9, time: '13:00', activity: 'å‰å¾€æ©Ÿå ´', location: 'é—œè¥¿åœ‹éš›æ©Ÿå ´', transport: 'å—æµ·é›»éµ', isEditing: false }, { id: 10, time: '16:00', activity: 'æº–å‚™ç™»æ©Ÿ', location: 'KIX -> HKG', transport: 'é£›æ©Ÿ', isEditing: false }] }
                  ];
                  const itinerary = ref(defaultItinerary);
                  
                  const shoppingList = ref([]);
                  const photos = ref([]);
                  const rate = ref(0.052);
                  const selectedExportDates = ref([]);
                  
                  const members = ref(['æˆ‘', 'æ—…ä¼´A']);
                  const newMemberName = ref('');
                  const showMemberSettings = ref(false);
                  const showSettlement = ref(false);

                  const categories = [
                      { id: 'shop', name: 'è³¼ç‰©', activeClass: 'bg-pink-500 text-white shadow-md shadow-pink-200', bg: 'bg-pink-100', text: 'text-pink-500' },
                      { id: 'daigou', name: 'ä»£è³¼', activeClass: 'bg-indigo-500 text-white shadow-md shadow-indigo-200', bg: 'bg-indigo-100', text: 'text-indigo-500' },
                      { id: 'food', name: 'é£²é£Ÿ', activeClass: 'bg-orange-500 text-white shadow-md shadow-orange-200', bg: 'bg-orange-100', text: 'text-orange-500' },
                      { id: 'gift', name: 'æ‰‹ä¿¡', activeClass: 'bg-purple-500 text-white shadow-md shadow-purple-200', bg: 'bg-purple-100', text: 'text-purple-500' },
                      { id: 'transport', name: 'äº¤é€š', activeClass: 'bg-blue-500 text-white shadow-md shadow-blue-200', bg: 'bg-blue-100', text: 'text-blue-500' },
                      { id: 'ticket', name: 'é–€ç¥¨', activeClass: 'bg-yellow-500 text-white shadow-md shadow-yellow-200', bg: 'bg-yellow-100', text: 'text-yellow-600' },
                      { id: 'other', name: 'å…¶ä»–', activeClass: 'bg-gray-600 text-white shadow-md shadow-gray-200', bg: 'bg-gray-100', text: 'text-gray-500' }
                  ];
                  const newItem = ref({ name: '', price: '', priceHKD: '', forWhom: '', category: 'shop', sharedWith: [0] });
                  const tempShopImg = ref(null);

                  const calcYen = ref('');
                  const calcHkd = ref('');
                  const showModal = ref(false);
                  const modalImage = ref('');

                  // æ—¥æœŸè¨ˆç®—é‚è¼¯
                  const updateItineraryDates = () => {
                      if (!startDate.value) return;
                      try {
                          const start = new Date(startDate.value);
                          if (isNaN(start.getTime())) return;

                          itinerary.value.forEach((day, index) => {
                              const current = new Date(start);
                              current.setDate(start.getDate() + index);
                              const m = (current.getMonth() + 1).toString().padStart(2, '0');
                              const d = current.getDate().toString().padStart(2, '0');
                              const w = weekDays[current.getDay()];
                              day.date = `${m}/${d} (${w})`;
                          });
                          
                          // æ›´æ–° End Date é¡¯ç¤º
                          if (itinerary.value.length > 0) {
                              const lastDay = new Date(start);
                              lastDay.setDate(start.getDate() + itinerary.value.length - 1);
                              endDate.value = lastDay.toISOString().split('T')[0];
                          }
                      } catch (e) { console.error("Date update error", e); }
                  };
                  
                  const tripDateRange = computed(() => {
                      if(!itinerary.value || itinerary.value.length === 0) return '';
                      const first = itinerary.value[0];
                      const last = itinerary.value[itinerary.value.length-1];
                      if (!first?.date || !last?.date) return '';
                      return `${first.date.split(' ')[0]} - ${last.date.split(' ')[0]}`;
                  });

                  const sortEvents = (dayIdx) => { 
                      if (itinerary.value[dayIdx] && itinerary.value[dayIdx].events) {
                          itinerary.value[dayIdx].events.sort((a, b) => a.time.localeCompare(b.time)); 
                      }
                  };
                  
                  onMounted(() => {
                      try {
                          const savedTitle = localStorage.getItem('minty_title_v1');
                          if (savedTitle) tripTitle.value = savedTitle;
                          
                          const savedStartDate = localStorage.getItem('minty_startdate_v1');
                          if (savedStartDate) startDate.value = savedStartDate;
                          else {
                              const today = new Date().toISOString().split('T')[0];
                              startDate.value = today;
                          }
                          
                          const savedItinerary = localStorage.getItem('minty_itinerary_v3');
                          if (savedItinerary) { 
                              const parsed = JSON.parse(savedItinerary);
                              if (Array.isArray(parsed)) {
                                  itinerary.value = parsed;
                                  itinerary.value.forEach((d, i) => sortEvents(i));
                              }
                          }
                          updateItineraryDates();
                      } catch(e) { console.error("Init error", e); }
                      
                      try {
                          const savedShopping = localStorage.getItem('minty_shopping_v2');
                          if (savedShopping) shoppingList.value = JSON.parse(savedShopping);
                      } catch(e) {}
                      try {
                          const savedPhotos = localStorage.getItem('minty_photos_v2');
                          if (savedPhotos) photos.value = JSON.parse(savedPhotos);
                      } catch(e) {}
                      try {
                          const savedRate = localStorage.getItem('minty_rate_v2');
                          if (savedRate) rate.value = Number(savedRate);
                      } catch(e) {}
                      try {
                          const savedMembers = localStorage.getItem('minty_members_v2');
                          if (savedMembers) members.value = JSON.parse(savedMembers);
                      } catch(e) {}
                  });

                  watch(startDate, (v) => {
                      localStorage.setItem('minty_startdate_v1', v);
                      updateItineraryDates();
                  });

                  watch(endDate, (newEnd) => {
                      if (!startDate.value || !newEnd) return;
                      const start = new Date(startDate.value);
                      const end = new Date(newEnd);
                      const diffTime = end - start;
                      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                      if (diffDays > 0) {
                          const currentLen = itinerary.value.length;
                          if (diffDays > currentLen) {
                              for (let i = 0; i < (diffDays - currentLen); i++) {
                                  itinerary.value.push({ events: [] });
                              }
                              updateItineraryDates();
                          } else if (diffDays < currentLen) {
                              if (confirm(`ç¢ºå®šè¦å°‡è¡Œç¨‹ç¸®çŸ­ç‚º ${diffDays} å¤©å—ï¼Ÿå¤šå‡ºçš„å¤©æ•¸è³‡æ–™å°‡è¢«åˆªé™¤ã€‚`)) {
                                  itinerary.value = itinerary.value.slice(0, diffDays);
                                  if (currentDayIndex.value >= diffDays) {
                                      currentDayIndex.value = 0;
                                  }
                              } else {
                                  updateItineraryDates(); 
                              }
                          }
                      }
                  });

                  watch(tripTitle, (v) => localStorage.setItem('minty_title_v1', v));
                  watch(itinerary, (v) => localStorage.setItem('minty_itinerary_v3', JSON.stringify(v)), { deep: true });
                  watch(shoppingList, (v) => localStorage.setItem('minty_shopping_v2', JSON.stringify(v)), { deep: true });
                  watch(photos, (v) => localStorage.setItem('minty_photos_v2', JSON.stringify(v)), { deep: true });
                  watch(rate, (v) => localStorage.setItem('minty_rate_v2', v));
                  watch(members, (v) => localStorage.setItem('minty_members_v2', JSON.stringify(v)), { deep: true });

                  const toggleEdit = (d, e) => { const evt = itinerary.value[d].events[e]; if(evt.isEditing) { evt.isEditing = false; sortEvents(d); } else { evt.isEditing = true; } };
                  const addEvent = (d) => itinerary.value[d].events.push({ id: Date.now(), time: '12:00', activity: 'æ–°è¡Œç¨‹', location: '', isEditing: true });
                  const deleteEvent = (d, e) => { if(confirm('åˆªé™¤ï¼Ÿ')) itinerary.value[d].events.splice(e, 1); };
                  const getMapLink = (l) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l || 'å¤§é˜ª')}`;
                  
                  const copyDayItineraryText = () => {
                      const day = itinerary.value[currentDayIndex.value];
                      if (!day) return;
                      let text = `ğŸ‡¯ğŸ‡µ ${tripTitle.value} - ${safeDate(day)}\n\n`;
                      const sortedEvents = [...day.events].sort((a, b) => a.time.localeCompare(b.time));
                      sortedEvents.forEach(e => {
                          text += `${e.time} ${e.activity}`;
                          if(e.location) text += ` @ ${e.location}`;
                          text += "\n";
                      });
                      navigator.clipboard.writeText(text).then(() => alert(`å·²è¤‡è£½ ${safeDate(day)} çš„è¡Œç¨‹ï¼`));
                  };

                  const copyItineraryText = () => { 
                      let t = `ğŸ‡¯ğŸ‡µ ${tripTitle.value} è¡Œç¨‹åˆ†äº«\n`; 
                      itinerary.value.forEach(d => { 
                          t += `\nğŸ“… ${safeDate(d)}\n`; 
                          [...d.events].sort((a,b)=>a.time.localeCompare(b.time)).forEach(e => t += `${e.time} ${e.activity} @${e.location||''}\n`); 
                      }); 
                      navigator.clipboard.writeText(t).then(()=>alert('æ•´è¶Ÿæ—…ç¨‹å·²è¤‡è£½ï¼')); 
                  };

                  const compressImage = (file, w, q, cb) => { const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); const x = c.getContext('2d'); let nw = i.width, nh = i.height; if(nw>w){nh*=w/nw;nw=w;} c.width=nw; c.height=nh; x.drawImage(i,0,0,nw,nh); cb(c.toDataURL('image/jpeg', q)); }; i.src = e.target.result; }; r.readAsDataURL(file); };
                  const handleShopImgUpload = (e) => { if(e.target.files[0]) compressImage(e.target.files[0], 600, 0.6, (res) => tempShopImg.value = res); };
                  
                  const addNewMember = () => {
                      if(newMemberName.value.trim()) {
                          members.value.push(newMemberName.value.trim());
                          newMemberName.value = '';
                      }
                  };

                  const deleteMember = (index) => {
                      if (index === 0) return; // ä¸èƒ½åˆªé™¤è‡ªå·±
                      const memberName = members.value[index];
                      if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${memberName} å—ï¼Ÿ\né€™å°‡å¾æ‰€æœ‰è¨˜å¸³ç´€éŒ„ä¸­ç§»é™¤æ­¤äººï¼Œä¸¦é‡æ–°è¨ˆç®— AA é‡‘é¡ã€‚`)) {
                          // 1. å¾æ‰€æœ‰è³¼ç‰©æ¸…å–®ä¸­ç§»é™¤è©² index
                          shoppingList.value.forEach(item => {
                              const idxInItem = item.sharedWith.indexOf(index);
                              if (idxInItem > -1) {
                                  item.sharedWith.splice(idxInItem, 1);
                                  // å¦‚æœåˆªé™¤å¾Œæ²’äººäº†ï¼Œé è¨­æ­¸å›è‡ªå·±
                                  if (item.sharedWith.length === 0) item.sharedWith.push(0);
                              }
                              // 2. ä¿®æ­£å¤§æ–¼è©² index çš„æ•¸å€¼ (å› ç‚ºé™£åˆ—é•·åº¦è®ŠçŸ­äº†ï¼Œå¾Œé¢çš„ index æœƒå¾€å‰ç§»)
                              item.sharedWith = item.sharedWith.map(i => {
                                  if (i > index) return i - 1;
                                  return i;
                              });
                          });
                          // 3. åˆªé™¤æˆå“¡
                          members.value.splice(index, 1);
                      }
                  };

                  const toggleMember = (idx) => {
                      const i = newItem.value.sharedWith.indexOf(idx);
                      if (i > -1) newItem.value.sharedWith.splice(i, 1);
                      else newItem.value.sharedWith.push(idx);
                  };

                  const addItem = () => { 
                      if (!newItem.value.name || (!newItem.value.price && !newItem.value.priceHKD)) return; 
                      const d = new Date();
                      const dateStr = `${d.getMonth()+1}/${d.getDate()}`; 
                      const finalShared = newItem.value.sharedWith.length > 0 ? [...newItem.value.sharedWith] : [0];
                      
                      shoppingList.value.unshift({ 
                          ...newItem.value, 
                          sharedWith: finalShared,
                          image: tempShopImg.value, 
                          date: dateStr 
                      }); 
                      newItem.value = { name: '', price: '', priceHKD: '', forWhom: '', category: 'shop', sharedWith: [0] }; 
                      tempShopImg.value = null; 
                  };
                  const deleteItem = (i) => shoppingList.value.splice(i, 1);
                  
                  const totalHKD = computed(() => shoppingList.value.reduce((sum, item) => {
                      if (item.priceHKD) return sum + Number(item.priceHKD); 
                      return sum + (Number(item.price || 0) * rate.value);   
                  }, 0).toFixed(1));

                  const totalYen = computed(() => shoppingList.value.reduce((sum, item) => {
                      if (item.price) return sum + Number(item.price);
                      if (item.priceHKD) return sum + (Number(item.priceHKD) / rate.value); 
                      return sum;
                  }, 0).toFixed(0));
                  
                  const categoryStats = computed(() => {
                      return categories.map(cat => {
                          const sumHKD = shoppingList.value
                              .filter(i => i.category === cat.id)
                              .reduce((acc, item) => {
                                  if(item.priceHKD) return acc + Number(item.priceHKD);
                                  return acc + (Number(item.price||0) * rate.value);
                              }, 0);
                          return { ...cat, sumHKD: sumHKD.toFixed(0) };
                      }).filter(c => c.sumHKD > 0);
                  });

                  const settlement = computed(() => {
                      const debts = {}; 
                      shoppingList.value.forEach(item => {
                          if (item.sharedWith && item.sharedWith.length > 0) {
                              let costHKD = 0;
                              if (item.priceHKD) costHKD = Number(item.priceHKD);
                              else costHKD = Number(item.price || 0) * rate.value;

                              const perPerson = costHKD / item.sharedWith.length;
                              item.sharedWith.forEach(memberIdx => {
                                  if (memberIdx !== 0 && members.value[memberIdx]) {
                                      if (!debts[memberIdx]) debts[memberIdx] = 0;
                                      debts[memberIdx] += perPerson;
                                  }
                              });
                          }
                      });
                      return debts;
                  });

                  const getCategoryName = (id) => categories.find(c => c.id === id)?.name || 'å…¶ä»–';
                  const getCategoryBg = (id) => categories.find(c => c.id === id)?.bg || 'bg-gray-100';
                  const getCategoryText = (id) => categories.find(c => c.id === id)?.text || 'text-gray-500';
                  
                  const getSharedNames = (indices) => {
                      if (!indices) return '';
                      return indices.map(i => members.value[i]).filter(n => n).join(', ');
                  };

                  const handlePhotoUpload = (e) => { if(e.target.files[0]) compressImage(e.target.files[0], 800, 0.7, (res) => { const d = new Date(); photos.value.unshift({ src: res, date: `${d.getMonth()+1}/${d.getDate()}`, originalIndex: 0 }); }); };
                  const groupedPhotos = computed(() => { const g = {}; photos.value.forEach((p, i) => { if(!g[p.date]) g[p.date]=[]; g[p.date].push({...p, originalIndex: i}); }); return g; });
                  const deletePhoto = (i) => { if(confirm('åˆªé™¤ï¼Ÿ')) photos.value.splice(i, 1); };

                  const downloadJSON = (d, n) => { const b = new Blob([JSON.stringify(d)], {type:'application/json'}); const l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = n; document.body.appendChild(l); l.click(); document.body.removeChild(l); };
                  
                  const exportToCSV = () => {
                      let csvContent = "\uFEFF"; // BOM for Excel UTF-8 compatibility
                      csvContent += "æ—¥æœŸ,åˆ†é¡,åç¨±,æ—¥åœ“(JPY),æ¸¯å¹£(HKD),AAåˆ†å¸³å°è±¡,å‚™è¨»\n";
                      
                      shoppingList.value.forEach(item => {
                          const category = getCategoryName(item.category);
                          const sharedNames = getSharedNames(item.sharedWith).replace(/,/g, 'ã€'); // é¿å… CSV é€—è™Ÿè¡çª
                          const jpy = item.price || 0;
                          const hkd = item.priceHKD || (item.price * rate.value).toFixed(1);
                          const note = (item.forWhom || '').replace(/,/g, ' ');
                          
                          csvContent += `"${item.date}","${category}","${item.name}",${jpy},${hkd},"${sharedNames}","${note}"\n`;
                      });
                      
                      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                      const link = document.createElement("a");
                      const url = URL.createObjectURL(blob);
                      link.setAttribute("href", url);
                      link.setAttribute("download", `${tripTitle.value}_è¨˜å¸³_${new Date().toISOString().slice(0,10)}.csv`);
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                  };

                  const exportSpecific = (type) => {
                      if(type === 'itinerary') downloadJSON(itinerary.value, 'Itinerary.json');
                      if(type === 'shopping') downloadJSON(shoppingList.value, 'ShoppingList.json');
                      if(type === 'photos') downloadJSON(photos.value, 'Photos.json');
                  };

                  const exportAllData = () => {
                      const fullData = { 
                          title: tripTitle.value,
                          startDate: startDate.value,
                          itinerary: itinerary.value, 
                          shopping: shoppingList.value, 
                          photos: photos.value, 
                          rate: rate.value, 
                          members: members.value, 
                          version: '7.3', 
                          backupDate: new Date().toLocaleString() 
                      };
                      downloadJSON(fullData, `Full_Backup_${Date.now()}.json`);
                  };

                  const exportByDate = () => {
                      if(selectedExportDates.value.length === 0) { alert('è«‹å…ˆå‹¾é¸æ—¥æœŸ'); return; }
                      const filteredItinerary = itinerary.value.filter(day => selectedExportDates.value.includes(day.date));
                      const targetDatesShort = selectedExportDates.value.map(d => { const parts = d.split(' ')[0].split('/'); return `${parseInt(parts[0])}/${parseInt(parts[1])}`; });
                      const filteredShopping = shoppingList.value.filter(item => item.date && targetDatesShort.includes(item.date));
                      const filteredPhotos = photos.value.filter(p => targetDatesShort.includes(p.date));
                      const partialData = { note: `Exported for dates: ${selectedExportDates.value.join(', ')}`, itinerary: filteredItinerary, shopping: filteredShopping, photos: filteredPhotos, rate: rate.value };
                      downloadJSON(partialData, `Partial_Backup_${Date.now()}.json`);
                  };

                  const importAllData = (e) => { const file = e.target.files[0]; if(!file) return; if(!confirm('ç¢ºå®šè¦å°å…¥å‚™ä»½å—ï¼Ÿé€™å°‡è¦†è“‹ç•¶å‰æ‰€æœ‰è³‡æ–™ï¼')) return; const reader = new FileReader(); reader.onload = (evt) => { try { const data = JSON.parse(evt.target.result); if(data.title) tripTitle.value = data.title; if(data.startDate) startDate.value = data.startDate; if(data.itinerary) itinerary.value = data.itinerary; if(data.shopping) shoppingList.value = data.shopping; if(data.photos) photos.value = data.photos; if(data.rate) rate.value = data.rate; if(data.members) members.value = data.members; updateItineraryDates(); itinerary.value.forEach((d, i) => sortEvents(i)); alert('ğŸ‰ æ•¸æ“šå·²æˆåŠŸæ¢å¾©ï¼'); } catch(err) { alert('å‚™ä»½æª”æ ¼å¼éŒ¯èª¤æˆ–æå£ã€‚'); } }; reader.readAsText(file); };

                  const resetAllData = () => {
                      if(confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰è¡Œç¨‹ã€è¨˜å¸³å’Œç…§ç‰‡æ•¸æ“šï¼Œæ¢å¾©åˆ°åˆå§‹ç‹€æ…‹ã€‚ç¢ºå®šå—ï¼Ÿ')) {
                          localStorage.clear();
                          location.reload();
                      }
                  };

                  const openImageModal = (src) => { modalImage.value = src; showModal.value = true; };
                  const updateHkd = () => { calcHkd.value = (calcYen.value * rate.value).toFixed(2); };
                  const updateYen = () => { calcYen.value = (calcHkd.value / rate.value).toFixed(0); };
                  const formatNumber = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                  return {
                      currentTab, currentDayIndex, itinerary, shoppingList, newItem, rate, totalYen, totalHKD, tempShopImg, photos, groupedPhotos, calcYen, calcHkd, showModal, modalImage, categories, selectedExportDates, categoryStats, members, newMemberName, showMemberSettings, showSettlement, settlement, tripTitle, startDate, endDate, tripDateRange, safeDate,
                      toggleEdit, addEvent, deleteEvent, getMapLink, copyItineraryText, copyDayItineraryText,
                      addItem, deleteItem, handleShopImgUpload, getCategoryName, getCategoryBg, getCategoryText, getSharedNames, toggleMember, addNewMember, deleteMember,
                      handlePhotoUpload, deletePhoto, openImageModal,
                      exportSpecific, exportAllData, exportByDate, importAllData, exportToCSV, resetAllData,
                      updateHkd, updateYen, formatNumber
                  };
              }
          }).mount('#app');
      </script>
  </body>
  </html>
